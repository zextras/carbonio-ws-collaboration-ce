targets=(
   "centos"
   "ubuntu"
)
pkgname="carbonio-ws-collaboration-ce"
pkgver="0.3.0"
pkgrel="2"
pkgdesc="Workstream Collaboration for Carbonio CE"
pkgdesclong=(
   "Workstream Collaboration for Carbonio CE"
)
maintainer="Zextras <packages@zextras.com>"
arch="amd64"
license=("spdx:AGPL-3.0-only")
section="admin"
priority="optional"
url="https://www.zextras.com/"
depends=(
   "pending-setups"
   "carbonio-openjdk"
   "service-discover"
   "jq"
)
backup=(
   "etc/carbonio/ws-collaboration/config.properties"
   "etc/carbonio/ws-collaboration/logback.xml"
   "etc/zextras/service-discover/carbonio-ws-collaboration.hcl"
)
sources=(
   "carbonio-ws-collaboration"
   "carbonio-ws-collaboration-configs"
   "carbonio-ws-collaboration.service"
   "carbonio-ws-collaboration.hcl"
   "carbonio-ws-collaboration-sidecar.service"
   "carbonio-ws-collaboration-setup.sh"
   "policies.json"
   "intentions.json"
   "service-protocol.json"
   "config.properties"
   "logback.xml"
)
hashsums=(
   "0e720e12361340e8e2d9d7fea1752a09cdc771cfe1f00e4979db5bc201956b40"
   "5b17a36bfc7255d2dddd1c0e8c3588a4286d682cb2b059f293fad4cfdcd85456"
   "bdcbec07d8c271b94bb8c804458d85a2e8a8d5bc556cb54df0429556dc4a934e"
   "766f41685994dbc891e9b03011e72edb688d989c5b27d39badbc59966748bb74"
   "5ab25236c2ba0a9e9c1577a3b6b1bb1497dba3fef40dd6851c3dfac86b685709"
   "97256a878d94c5239c422049c9360ca18e1c34c74b3e6ac2a93e51ae0419b423"
   "63e825d819e29df9edda3ae8e2af954176dda0592961ebc0d035508137db540b"
   "58c69efd45348762b3c603ecb8a7d3df5e4ada730b00a760d02d3f376a455d08"
   "d3741e4103a786c40a319248258ee5a25a39174a6ba80973b5877bb8a5e2bf72"
   "62d45c9fad3a1a3680871a9a57131242d9a34ea41b370bb2c78f90914b1dc65e"
   "a993f63dbfa8273d92f004c6db2886f17d9876d36c65ab757456ab99c0a3f3c3"
)

package() {
  cd "${srcdir}"/../../ws-collaboration
  install -Dm 644 ./carbonio-ws-collaboration-ce-boot/target/carbonio-ws-collaboration-ce-fatjar.jar \
    "${pkgdir}/usr/bin/carbonio/ws-collaboration/carbonio-ws-collaboration.jar"

  cd "${srcdir}"
  install -Dm 755 carbonio-ws-collaboration "${pkgdir}/usr/bin/carbonio-ws-collaboration"
  install -Dm 755 carbonio-ws-collaboration-configs "${pkgdir}/usr/bin/carbonio-ws-collaboration-configs"
  install -Dm 644 config.properties "${pkgdir}/etc/carbonio/ws-collaboration/config.properties"
  install -Dm 644 logback.xml "${pkgdir}/etc/carbonio/ws-collaboration/logback.xml"
  install -Dm 644 carbonio-ws-collaboration.service "${pkgdir}/lib/systemd/system/carbonio-ws-collaboration.service"
  install -Dm 644 carbonio-ws-collaboration-sidecar.service "${pkgdir}/lib/systemd/system/carbonio-ws-collaboration-sidecar.service"
  install -Dm 644 carbonio-ws-collaboration.hcl "${pkgdir}/etc/zextras/service-discover/carbonio-ws-collaboration.hcl"
  install -Dm 644 carbonio-ws-collaboration-setup.sh "${pkgdir}/etc/zextras/pending-setups.d/carbonio-ws-collaboration.sh"
  install -Dm 644 policies.json "${pkgdir}/etc/carbonio/ws-collaboration/service-discover/policies.json"
  install -Dm 644 intentions.json "${pkgdir}/etc/carbonio/ws-collaboration/service-discover/intentions.json"
  install -Dm 644 service-protocol.json "${pkgdir}/etc/carbonio/ws-collaboration/service-discover/service-protocol.json"
}

postinst() {
  getent group 'carbonio-ws-collaboration' >/dev/null ||
    groupadd -r 'carbonio-ws-collaboration'
  getent passwd 'carbonio-ws-collaboration' >/dev/null ||
    useradd -r -M -g 'carbonio-ws-collaboration' -s /sbin/nologin 'carbonio-ws-collaboration'

  mkdir -p /var/log/carbonio/ws-collaboration
  chown carbonio-ws-collaboration:carbonio-ws-collaboration /var/log/carbonio/ws-collaboration

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-ws-collaboration.service >/dev/null 2>&1 || :
    systemctl enable carbonio-ws-collaboration-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio Workstream Collaboration installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-ws-collaboration.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-ws-collaboration-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-ws-collaboration.service >/dev/null 2>&1 || :
    systemctl stop carbonio-ws-collaboration-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm() {
  rm -f /etc/carbonio/ws-collaboration/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}
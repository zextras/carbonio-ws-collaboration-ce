targets=(
   "centos"
   "ubuntu"
)
pkgname="carbonio-chats-ce"
pkgver="0.3.0"
pkgrel="1"
pkgdesc="Chats for carbonio CE"
pkgdesclong=(
   "Chats for carbonio CE"
)
maintainer="Zextras <packages@zextras.com>"
arch="amd64"
license=("spdx:AGPL-3.0-only")
section="admin"
priority="optional"
url="https://www.zextras.com/"
depends=(
   "pending-setups"
   "carbonio-openjdk"
   "service-discover"
   "jq"
)
backup=(
   "etc/carbonio/chats/config.properties"
   "etc/carbonio/chats/logback.xml"
   "etc/zextras/service-discover/carbonio-chats.hcl"
)
sources=(
   "carbonio-chats"
   "carbonio-chats-configs"
   "carbonio-chats.service"
   "carbonio-chats.hcl"
   "carbonio-chats-sidecar.service"
   "carbonio-chats-setup.sh"
   "policies.json"
   "intentions.json"
   "service-protocol.json"
   "config.properties"
   "logback.xml"
)
hashsums=(
   "16c6f2c6023f5d5237f9c8f56f54c47f22280c49bf81baa7ea90645bb9be4750"
   "edebf9af07757a7039f8d03854a4295728c8fc5f5ba917650cead4e03dc193d7"
   "skip"
   "a64fb33d918a17d343ff8f16ed9124f6c92cf5388c2d0519e1740e4adee5f668"
   "407d7bdf5c3165b06663b18ccb8634004f8c4fc93775766fe61fdaa94bdf738c"
   "4e08617f44dc095eeca58944b1b870214914130fdfbdf2f0a26a2154d84da552"
   "c3cc92f6d1ac5c6625086f5b3bf5a718cb34ca7713b972205e34fcea76e791f1"
   "0470b9333a8bf2d6b3a0a2bcd6111c63292f5f02a293cc08105c86dcc369de9d"
   "9a5ac6516f976640b9fb4e0e4f5de03776b4caa9f24b181c4ff898db06be1147"
   "bee12d4b1e5ebee035f3544c9e0915564609184e42b9cbe45584868b9343a6fe"
   "a712783931d0f0d8da733e28280394db468a7e1d4e71b54e0bbdf171617fea0e"
)

package() {
  cd "${srcdir}"/../../chats
  install -Dm 644 ./carbonio-chats-ce-boot/target/carbonio-chats-ce-fatjar.jar \
    "${pkgdir}/usr/bin/carbonio/chats/carbonio-chats.jar"

  cd "${srcdir}"
  install -Dm 755 carbonio-chats "${pkgdir}/usr/bin/carbonio-chats"
  install -Dm 755 carbonio-chats-configs "${pkgdir}/usr/bin/carbonio-chats-configs"
  install -Dm 644 config.properties "${pkgdir}/etc/carbonio/chats/config.properties"
  install -Dm 644 logback.xml "${pkgdir}/etc/carbonio/chats/logback.xml"
  install -Dm 644 carbonio-chats.service "${pkgdir}/lib/systemd/system/carbonio-chats.service"
  install -Dm 644 carbonio-chats-sidecar.service "${pkgdir}/lib/systemd/system/carbonio-chats-sidecar.service"
  install -Dm 644 carbonio-chats.hcl "${pkgdir}/etc/zextras/service-discover/carbonio-chats.hcl"
  install -Dm 644 carbonio-chats-setup.sh "${pkgdir}/etc/zextras/pending-setups.d/carbonio-chats.sh"
  install -Dm 644 policies.json "${pkgdir}/etc/carbonio/chats/service-discover/policies.json"
  install -Dm 644 intentions.json "${pkgdir}/etc/carbonio/chats/service-discover/intentions.json"
  install -Dm 644 service-protocol.json "${pkgdir}/etc/carbonio/chats/service-discover/service-protocol.json"
}

postinst() {
  getent group 'carbonio-chats' >/dev/null ||
    groupadd -r 'carbonio-chats'
  getent passwd 'carbonio-chats' >/dev/null ||
    useradd -r -M -g 'carbonio-chats' -s /sbin/nologin 'carbonio-chats'

  mkdir -p /var/log/carbonio/chats
  chown carbonio-chats:carbonio-chats /var/log/carbonio/chats

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-chats.service >/dev/null 2>&1 || :
    systemctl enable carbonio-chats-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio chats installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-chats.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-chats-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-chats.service >/dev/null 2>&1 || :
    systemctl stop carbonio-chats-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm() {
  rm -f /etc/carbonio/chats/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}